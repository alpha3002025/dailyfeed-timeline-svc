apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: {{ .Values.appName }}
  name: {{ .Values.appName }}
  namespace: {{ .Values.namespace }}
spec:
  replicas: {{ .Values.replicas }}
  selector:
    matchLabels:
      app: {{ .Values.appName }}
  strategy: 
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: {{ .Values.appName }}
    spec:
      containers:
      - image: nginx
        name: nginx
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: {{ .Values.profile }}
        {{- with .Values.envValues }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- if .Values.configSecretItems}}
        envFrom:
          {{- range .Values.configSecretItems }}
          - configMapRef:
              name: {{ . | trimSuffix "-nosecret" }}-config
          {{- if not (hasSuffix "-nosecret" .)}}
          - secretRef:
              name: {{ . }}-secret
          {{- end}}
          {{- end}}
        {{- end}}
      - image: alpha300uk/{{ .Values.appName }}-svc:{{ .Values.imageTag }}
        name: {{ .Values.appName }}
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: {{ .Values.profile }}
        - name: MYSQL_JDBC_URL
          value: "jdbc:mysql://mysql.infra.svc.cluster.local:3306/dailyfeed?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC&characterEncoding=UTF-8"
        - name: MYSQL_USERNAME
          value: "dailyfeed"
        - name: MYSQL_PASSWORD
          value: "hitEnter###"
        - name: MYSQL_SCHEMA
          value: "dailyfeed"
        - name: REDIS_HOST
          value: "redis-master.infra.svc.cluster.local"
        - name: REDIS_PORT
          value: "6379"
        {{- with .Values.envValues }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- if .Values.configSecretItems}}
        envFrom:
          {{- range .Values.configSecretItems }}
          - configMapRef:
              name: {{ . | trimSuffix "-nosecret" }}-config
          {{- if not (hasSuffix "-nosecret" .)}}
          - secretRef:
              name: {{ . }}-secret
          {{- end}}
          {{- end}}
        {{- end}}
        resources: 
          requests:
            memory: {{ .Values.resources.memory.requests }}
            cpu: {{ .Values.resources.cpu.requests }}
          limits:
            memory: {{ .Values.resources.memory.limits }}
            cpu: {{ .Values.resources.cpu.limits }}
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "sleep 10"]
        {{- with .Values.porbeValues.readiness }}
        readinessProbe:
          httpGet:
            path: {{ .httpGetPath }}
            port: {{ .httpGetPort }}
          initialDelaySeconds: {{ .initialDelaySeconds }}
          periodSeconds: {{ .periodSeconds }}
          successThreshold: {{ .successThreshold }}
          failureThreshold: {{ .failureThreshold }}
        {{- end }}
        {{- with .Values.porbeValues.liveness }}
        livenessProbe:
          httpGet:
            path: {{ .httpGetPath }}
            port: {{ .httpGetPort }}
          initialDelaySeconds: {{ .initialDelaySeconds }}
          periodSeconds: {{ .periodSeconds }}
          failureThreshold: {{ .failureThreshold }}
        {{- end}}
        {{- with .Values.porbeValues.startup}}
        startupProbe:
          httpGet:
            path: {{ .httpGetPath }}
            port: {{ .httpGetPort }}
          initialDelaySeconds: {{ .initialDelaySeconds }}
          periodSeconds: {{ .periodSeconds }}
          failureThreshold: {{ .failureThreshold }}
        {{- end}}
status: {}